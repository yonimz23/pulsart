<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal | Conecta 360¬∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --brand-primary: #FF9900; --brand-accent: #9ECA57; --brand-dark: #111111; --bg-light: #F4F4F4; --white: #FFFFFF; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-light); color: #333; height: 100vh; overflow: hidden; display: flex; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--brand-dark); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: opacity 0.5s; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--brand-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); display: none; justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        .login-card { background: white; padding: 40px 30px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--brand-primary); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; font-family: inherit; }
        .btn-login { width: 100%; padding: 12px; background: var(--brand-dark); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; }

        #admin-view { display: none; width: 100%; height: 100%; }
        .sidebar { width: 260px; background: var(--brand-dark); color: white; display: flex; flex-direction: column; padding: 25px; height: 100vh; }
        .menu-item { padding: 15px; cursor: pointer; border-radius: 10px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; color: #aaa; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: var(--white); }
        
        .main { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg-light); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-add { background: var(--brand-accent); color: var(--brand-dark); border: none; padding: 12px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;}

        .table-card { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #fafafa; padding: 15px; text-align: left; font-size: 0.85rem; color: #666; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        
        .badge-plan { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .plan-basico { background: #eee; color: #555; }
        .plan-desarrollo { background: #e3f2fd; color: #1565c0; }
        .plan-pro { background: #e8f5e9; color: #2e7d32; }
        .plan-premium { background: #fff3e0; color: #ef6c00; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 1.1rem; color: #999; margin-left: 5px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2.5rem; font-weight: 900; color: var(--brand-dark); margin-top: 10px; }

        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--brand-dark); z-index: 1000; justify-content: space-around; padding: 10px 0; }
            .mobile-link { color: #777; background: none; border: none; font-size: 1.2rem; }
            .mobile-link.active { color: var(--brand-primary); }
            .main { padding: 20px; padding-bottom: 80px; }
        }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        
        .time-input-group { display: flex; gap: 10px; }
        .time-box { flex: 1; }
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div><p>CARGANDO...</p></div>

    <div id="login-view">
        <div class="login-card">
            <img src="img/conecta.png" style="width:150px; margin-bottom:20px;">
            <form id="adminLoginForm">
                <input type="email" id="adminEmail" class="form-input" placeholder="Email Admin" required>
                <input type="password" id="adminPass" class="form-input" placeholder="Contrase√±a" required>
                <button type="submit" class="btn-login">ENTRAR</button>
            </form>
        </div>
    </div>

    <div id="admin-view">
        <nav class="sidebar">
            <div style="color:var(--brand-primary); font-weight:800; margin-bottom:40px;">ADMIN CONECTA</div>
            <div class="menu-item active" id="btn-dash" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="menu-item" id="btn-users" onclick="switchTab('users')"><i class="fas fa-users"></i> Usuarios</div>
            <div class="menu-item" id="btn-agenda" onclick="switchTab('agenda')"><i class="fas fa-calendar-alt"></i> Agenda</div>
            <div class="menu-item" id="btn-inventory" onclick="switchTab('inventory')"><i class="fas fa-box-open"></i> Inventario</div>
            <div class="menu-item" id="btn-history" onclick="switchTab('history')"><i class="fas fa-history"></i> Historial</div>
            <div class="menu-item" id="btn-settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Ajustes</div>
            <div class="menu-item" onclick="logout()" style="margin-top:auto;"><i class="fas fa-sign-out-alt"></i> Salir</div>
        </nav>

        <main class="main">
            <div id="dashboard-section">
                <h1 style="margin-bottom:20px;">Resumen</h1>
                <div class="stats-grid">
                    <div class="stat-card"><div>USUARIOS</div><div class="stat-value" id="stat-total-users">0</div></div>
                    <div class="stat-card"><div>EN SESI√ìN</div><div class="stat-value" id="stat-active-sessions" style="color:green;">0</div></div>
                    <div class="stat-card"><div>EQUIPOS OK</div><div class="stat-value" id="stat-inventory-ok">0</div></div>
                </div>
                <div class="table-card" style="padding:20px; height:350px;">
                    <h3>Distribuci√≥n de Planes</h3>
                    <canvas id="plansChart"></canvas>
                </div>
            </div>

            <div id="users-section" style="display:none;">
                <div class="header"><h1>Usuarios</h1><button class="btn-add" onclick="openModal()">+ Nuevo</button></div>
                <div class="table-card">
                    <table>
                        <thead><tr><th>Usuario</th><th>Plan</th><th>Control</th></tr></thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="agenda-section" style="display:none;">
                <div class="header">
                    <div><h1>Agenda</h1><p style="color:#666;">Vista r√°pida.</p></div>
                    <button class="btn-add" style="background:#4285F4; color:white;" onclick="window.open('https://calendar.google.com/calendar/r', '_blank')"><i class="fas fa-external-link-alt"></i> Editar</button>
                </div>
                <div class="table-card" style="height:75vh; padding:0; overflow:hidden;">
                    <iframe id="admin-calendar-frame" src="" style="border: 0" width="100%" height="100%" frameborder="0"></iframe>
                </div>
            </div>

            <div id="inventory-section" style="display:none;">
                <div class="header"><h1>Inventario</h1><button class="btn-add" onclick="openInventoryModal()">+ Item</button></div>
                <div class="table-card">
                    <table>
                        <thead><tr><th>Item</th><th>Cant.</th><th>Estado</th><th>Borrar</th></tr></thead>
                        <tbody id="inventoryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="history-section" style="display:none;">
                <div class="header"><h1>Historial</h1><button class="btn-add" style="background:#2ecc71; color:white;" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Exportar</button></div>
                <div class="table-card" style="margin-top:20px;">
                    <table>
                        <thead><tr><th>Fecha</th><th>Usuario</th><th>Servicio</th><th>Duraci√≥n</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="settings-section" style="display:none;">
                <h1>Configuraci√≥n</h1>
                <div class="table-card" style="padding:20px; max-width:500px;">
                    <p style="margin-bottom:5px;">Google Calendar URL</p>
                    <input id="calendarLinkInput" class="form-input">
                    <p style="margin-bottom:5px;">WhatsApp Negocio</p>
                    <input id="whatsappInput" class="form-input">
                    <button class="btn-login" onclick="saveSettings()">Guardar Cambios</button>
                </div>
            </div>
        </main>

        <nav class="mobile-nav">
            <button class="mobile-link active" id="mob-dash" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i></button>
            <button class="mobile-link" id="mob-users" onclick="switchTab('users')"><i class="fas fa-users"></i></button>
            <button class="mobile-link" id="mob-agenda" onclick="switchTab('agenda')"><i class="fas fa-calendar-alt"></i></button>
            <button class="mobile-link" id="mob-history" onclick="switchTab('history')"><i class="fas fa-history"></i></button>
            <button class="mobile-link" id="mob-settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i></button>
        </nav>
    </div>

    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <h2>Gesti√≥n de Usuario</h2>
            <form id="userForm" style="margin-top:20px;">
                <input type="hidden" id="editUid">
                
                <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:bold; color:#666;">DATOS B√ÅSICOS</label>
                    <input type="text" id="name" class="form-input" placeholder="Nombre" required style="margin-top:5px;">
                    <input type="email" id="email" class="form-input" placeholder="Email" required>
                    <input type="tel" id="phone" class="form-input" placeholder="Tel√©fono">
                    <select id="plan" class="form-input"><option value="basico">B√°sico</option><option value="desarrollo">Desarrollo</option><option value="pro">Pro</option><option value="premium">Premium</option></select>
                    <div id="passGroup"><input type="password" id="password" class="form-input" placeholder="Crear Contrase√±a (Solo nuevos)"></div>
                </div>

                <div style="background:#fff8e1; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:bold; color:#f57c00;">üìÇ LINK DE ENTREGABLES (Drive/Dropbox)</label>
                    <input type="url" id="deliverableLink" class="form-input" placeholder="https://drive.google.com/..." style="margin-top:5px; margin-bottom:0;">
                </div>

                <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:bold; color:#1565c0;">üì¢ MENSAJE PARA EL CLIENTE (Bit√°cora)</label>
                    <textarea id="advisoryNotes" class="form-input" placeholder="Feedback visible en la App..." rows="3" style="margin-top:5px; border:2px solid #2196f3;"></textarea>
                </div>

                <div style="background:#fff3e0; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:bold; color:#ef6c00;">üîí NOTAS PRIVADAS (Solo Admin)</label>
                    <textarea id="internalNotes" class="form-input" placeholder="Notas internas..." rows="2" style="margin-top:5px;"></textarea>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closeModal()" style="padding:10px;">Cancelar</button>
                    <button type="submit" class="btn-login" style="width:auto; padding:10px 20px;">Guardar Todo</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="sessionModal">
        <div class="modal">
            <h2 style="margin-bottom:15px;">‚è±Ô∏è Iniciar Sesi√≥n</h2>
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Servicio</label>
            <select id="startService" class="form-input">
                <option value="Estudio de Grabaci√≥n">üéôÔ∏è Estudio de Grabaci√≥n</option>
                <option value="Sesi√≥n de Fotos">üì∏ Sesi√≥n de Fotos</option>
                <option value="Asesor√≠a">üéì Asesor√≠a</option>
                <option value="Sala de Ensayo">üé∏ Sala de Ensayo</option>
                <option value="Uso de Equipos">üéß Uso de Equipos</option>
            </select>
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Tiempo L√≠mite</label>
            <div class="time-input-group" style="margin-bottom:20px;">
                <div class="time-box"><input type="number" id="startHours" class="form-input" placeholder="0" min="0" value="0"><small style="color:#666;">Horas</small></div>
                <div class="time-box"><input type="number" id="startMinutes" class="form-input" placeholder="0" min="0" value="0"><small style="color:#666;">Minutos</small></div>
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button type="button" onclick="closeSessionModal()" style="padding:10px;">Cancelar</button>
                <button type="button" onclick="confirmStartSession()" class="btn-login" style="width:auto; padding:10px 20px; background:green;">‚ñ∂Ô∏è INICIAR</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="inventoryModal">
        <div class="modal">
            <h2 style="margin-bottom:15px;">üì¶ Nuevo Equipo</h2>
            <form id="inventoryForm">
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Nombre del Item</label>
                <input type="text" id="invName" class="form-input" placeholder="Ej: Micr√≥fono Shure" required>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Cantidad</label>
                        <input type="number" id="invQty" class="form-input" value="1" min="1" required>
                    </div>
                    <div style="flex:1;">
                        <label style="font-weight:bold; display:block; margin-bottom:5px;">Estado</label>
                        <select id="invStatus" class="form-input"><option value="OK">üü¢ Operativo</option><option value="REPARACI√ìN">üü† En Reparaci√≥n</option><option value="FALTA">üî¥ Perdido/Falta</option></select>
                    </div>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                    <button type="button" onclick="closeInventoryModal()" style="padding:10px;">Cancelar</button>
                    <button type="submit" class="btn-login" style="width:auto; padding:10px 20px;">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBve-f9-BAlYHdgLx0NLjwMK8z5l8C8yW4",
            authDomain: "conecta360-c0259.firebaseapp.com",
            projectId: "conecta360-c0259",
            storageBucket: "conecta360-c0259.firebasestorage.app",
            messagingSenderId: "614768909024",
            appId: "1:614768909024:web:2bb1dc4cc5ecd3efe54e85"
        };
        const ADMIN_EMAIL = "admin@conecta360.com";

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
        let chartInstance = null;
        let currentSessionUid = null;
        let allUsersData = {};

        setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 5000);

        auth.onAuthStateChanged(user => {
            document.getElementById('loading-screen').style.display = 'none';
            if(user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('admin-view').style.display = 'flex';
                initDashboard();
                loadSettings();
            } else {
                if(user) auth.signOut();
                document.getElementById('login-view').style.display = 'flex';
            }
        });

        document.getElementById('adminLoginForm').addEventListener('submit', e => {
            e.preventDefault();
            document.getElementById('loading-screen').style.display = 'flex';
            auth.signInWithEmailAndPassword(document.getElementById('adminEmail').value, document.getElementById('adminPass').value)
            .catch(err => { document.getElementById('loading-screen').style.display = 'none'; alert(err.message); });
        });

        function switchTab(tab) {
            ['dashboard', 'users', 'agenda', 'inventory', 'history', 'settings'].forEach(t => {
                const el = document.getElementById(t+'-section');
                if(el) el.style.display = (t === tab) ? 'block' : 'none';
                const btn = document.getElementById('btn-'+t);
                if(btn) btn.classList.toggle('active', t === tab);
                const mob = document.getElementById('mob-'+t);
                if(mob) mob.classList.toggle('active', t === tab);
            });
            if(tab === 'inventory') loadInventory();
            if(tab === 'history') loadHistory();
            if(tab === 'agenda') loadSettings();
        }

        function initDashboard() {
            db.collection("usuarios").onSnapshot(snap => {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                let active = 0, plans = {basico:0, desarrollo:0, pro:0, premium:0}, total = 0;
                allUsersData = {};

                snap.forEach(doc => {
                    const u = doc.data();
                    allUsersData[doc.id] = u;
                    total++;
                    if(u.session && u.session.active) active++;
                    if(plans[u.plan_actual] !== undefined) plans[u.plan_actual]++;

                    const isActive = u.session && u.session.active;
                    let timerHtml = "";
                    
                    if(isActive) {
                        const end = u.session.startTime + (u.session.duration || 7200000);
                        // AQUI SE GUARDAN LOS DATOS DE DURACI√ìN PARA EL AUTOCIERRE
                        timerHtml = `<div class="admin-timer" 
                                        data-end="${end}" 
                                        data-uid="${doc.id}" 
                                        data-name="${u.nombre}" 
                                        data-service="${u.session.service}"
                                        data-duration="${u.session.duration || 0}"
                                        style="color:green; font-weight:bold;">Calculando...</div>`;
                    }
                    const btn = isActive 
                        ? `<button class="btn-icon" style="color:red" onclick="toggleSession('${doc.id}',false,'${u.nombre}','${u.session.service}')" title="DETENER"><i class="fas fa-stop"></i></button>`
                        : `<button class="btn-icon" style="color:green" onclick="toggleSession('${doc.id}',true)" title="INICIAR"><i class="fas fa-play"></i></button>`;

                    tbody.innerHTML += `<tr>
                        <td><b>${u.nombre}</b><br><small>${u.email}</small><br>${timerHtml}</td>
                        <td><span class="badge-plan plan-${u.plan_actual}">${u.plan_actual}</span></td>
                        <td>${btn} <button class="btn-icon" onclick="editUser('${doc.id}')"><i class="fas fa-edit"></i></button></td>
                    </tr>`;
                });

                document.getElementById('stat-total-users').innerText = total;
                document.getElementById('stat-active-sessions').innerText = active;
                try {
                    const ctx = document.getElementById('plansChart');
                    if(ctx) {
                        if(chartInstance) chartInstance.destroy();
                        chartInstance = new Chart(ctx.getContext('2d'), {
                            type: 'doughnut',
                            data: { labels: ['B√°sico', 'Desarrollo', 'Pro', 'Premium'], datasets: [{ data: [plans.basico, plans.desarrollo, plans.pro, plans.premium], backgroundColor: ['#eee','#bbdefb','#c8e6c9','#ffe0b2'] }] }
                        });
                    }
                } catch(e) {}
            });
        }

        // --- SISTEMA DE AUTOCIERRE ---
        setInterval(() => {
            document.querySelectorAll('.admin-timer').forEach(el => {
                if(el.getAttribute('data-closing') === 'true') return;

                const end = parseInt(el.getAttribute('data-end'));
                const diff = end - Date.now();

                if(diff <= 0) { 
                    el.innerText = "üíæ Finalizando..."; 
                    el.style.color = "red";
                    el.setAttribute('data-closing', 'true');

                    const uid = el.getAttribute('data-uid');
                    const name = el.getAttribute('data-name');
                    const service = el.getAttribute('data-service');
                    // LEER DURACI√ìN DEL DATA ATTRIBUTE
                    const durationMs = parseInt(el.getAttribute('data-duration'));
                    
                    // FORMATO "2h 30m"
                    const h = Math.floor(durationMs / 3600000);
                    const m = Math.floor((durationMs % 3600000) / 60000);
                    const timeText = `${h}h ${m}m`;

                    db.collection("historial").add({ 
                        uid: uid, 
                        usuario: name, 
                        servicio: service, 
                        fecha: new Date(), 
                        duracion: timeText // GUARDAR EL TIEMPO CONTRATADO
                    }).then(() => {
                        db.collection("usuarios").doc(uid).update({ session:null });
                    });

                } else {
                    const h = Math.floor(diff/3600000);
                    const m = Math.floor((diff%3600000)/60000);
                    const s = Math.floor((diff%60000)/1000);
                    el.innerText = `üü¢ ${h}h ${m}m ${s}s`;
                }
            });
        }, 1000);

        function toggleSession(uid, start, name, srv) {
            if(start) {
                currentSessionUid = uid;
                document.getElementById('sessionModal').style.display = 'flex';
                document.getElementById('startHours').value = 0;
                document.getElementById('startMinutes').value = 0;
            } else {
                if(confirm("¬øFinalizar sesi√≥n y guardar en historial de forma anticipada?")) {
                    db.collection("usuarios").doc(uid).get().then(doc => {
                        const data = doc.data();
                        if (data.session && data.session.active) {
                            const elapsedMs = Date.now() - data.session.startTime;
                            const h = Math.floor(elapsedMs / 3600000);
                            const m = Math.floor((elapsedMs % 3600000) / 60000);
                            
                            db.collection("historial").add({ 
                                uid: uid, 
                                usuario: name, 
                                servicio: srv, 
                                fecha: new Date(), 
                                duracion: `${h}h ${m}m` 
                            });
                            db.collection("usuarios").doc(uid).update({ session:null });
                        }
                    });
                }
            }
        }
        function closeSessionModal() { document.getElementById('sessionModal').style.display = 'none'; currentSessionUid = null; }
        function confirmStartSession() {
            if (!currentSessionUid) return;
            const service = document.getElementById('startService').value;
            const hours = parseInt(document.getElementById('startHours').value) || 0;
            const minutes = parseInt(document.getElementById('startMinutes').value) || 0;
            if (hours === 0 && minutes === 0) return alert("Ingresa tiempo.");
            const totalMs = (hours * 3600000) + (minutes * 60000);
            db.collection("usuarios").doc(currentSessionUid).update({ session: { active: true, service: service, startTime: Date.now(), duration: totalMs } })
            .then(() => closeSessionModal());
        }

        function exportToExcel() {
            db.collection("historial").orderBy("fecha", "desc").get().then(snap => {
                let csvContent = "data:text/csv;charset=utf-8,FECHA,USUARIO,SERVICIO,DURACION\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.fecha.toDate ? d.fecha.toDate().toLocaleDateString() : new Date(d.timestamp).toLocaleDateString();
                    csvContent += `${date},${d.usuario},${d.servicio},${d.duracion || '-'}\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "historial.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });
        }

        function loadInventory(){ db.collection("inventario").onSnapshot(s => { 
            let html=""; let ok=0; s.forEach(d => { const i=d.data(); if(i.estado==='OK') ok++; html+=`<tr><td>${i.item}</td><td>${i.cantidad}</td><td>${i.estado}</td><td><button class='btn-icon' onclick="if(confirm('¬øBorrar?')) db.collection('inventario').doc('${d.id}').delete()">üóë</button></td></tr>`; });
            document.getElementById('inventoryTableBody').innerHTML=html; document.getElementById('stat-inventory-ok').innerText=ok;
        });}
        function openInventoryModal() { document.getElementById('inventoryModal').style.display = 'flex'; document.getElementById('inventoryForm').reset(); }
        function closeInventoryModal() { document.getElementById('inventoryModal').style.display = 'none'; }
        document.getElementById('inventoryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            db.collection("inventario").add({ item: document.getElementById('invName').value, cantidad: parseInt(document.getElementById('invQty').value), estado: document.getElementById('invStatus').value })
            .then(() => { closeInventoryModal(); });
        });
        
        function loadHistory(){ db.collection("historial").orderBy("fecha","desc").limit(20).get().then(s => {
            let html=""; s.forEach(d=>{ const data=d.data(); html+=`<tr><td>${data.fecha.toDate().toLocaleDateString()}</td><td>${data.usuario}</td><td>${data.servicio}</td><td style="font-weight:bold;">${data.duracion || '-'}</td></tr>`; });
            document.getElementById('historyTableBody').innerHTML=html;
        });}

        const form = document.getElementById('userForm');
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const uid = document.getElementById('editUid').value;
            const data = { 
                nombre: document.getElementById('name').value, 
                email: document.getElementById('email').value, 
                telefono: document.getElementById('phone').value, 
                plan_actual: document.getElementById('plan').value,
                internalNotes: document.getElementById('internalNotes').value, 
                advisoryNotes: document.getElementById('advisoryNotes').value, 
                deliverableLink: document.getElementById('deliverableLink').value 
            };
            if(uid) await db.collection("usuarios").doc(uid).update(data);
            else { const p = document.getElementById('password').value; const c = await secondaryApp.auth().createUserWithEmailAndPassword(data.email, p); await db.collection("usuarios").doc(c.user.uid).set(data); await secondaryApp.auth().signOut(); }
            closeModal();
        });
        function openModal(){ document.getElementById('userModal').style.display='flex'; document.getElementById('editUid').value=''; form.reset(); document.getElementById('passGroup').style.display='block'; }
        function closeModal(){ document.getElementById('userModal').style.display='none'; }
        function editUser(id){ 
            openModal(); const u = allUsersData[id]; 
            document.getElementById('editUid').value=id; 
            document.getElementById('name').value=u.nombre; 
            document.getElementById('email').value=u.email; 
            document.getElementById('plan').value=u.plan_actual; 
            document.getElementById('phone').value=u.telefono; 
            document.getElementById('internalNotes').value = u.internalNotes || "";
            document.getElementById('advisoryNotes').value = u.advisoryNotes || ""; 
            document.getElementById('deliverableLink').value = u.deliverableLink || "";
            document.getElementById('email').disabled=true; 
            document.getElementById('passGroup').style.display='none'; 
        }
        
        function loadSettings(){ db.collection("config").doc("general").get().then(d => { 
            if(d.exists) { 
                const data=d.data(); 
                document.getElementById('calendarLinkInput').value=data.calendarUrl||""; 
                document.getElementById('whatsappInput').value=data.whatsapp||""; 
                if(data.calendarUrl) document.getElementById('admin-calendar-frame').src = data.calendarUrl + "&mode=MONTH&showTitle=0&showNav=1";
            } 
        }); }
        function saveSettings(){ db.collection("config").doc("general").set({ calendarUrl:document.getElementById('calendarLinkInput').value, whatsapp:document.getElementById('whatsappInput').value }, {merge:true}).then(()=>alert("Guardado")); }
        function logout(){ auth.signOut().then(()=>location.reload()); }
    </script>
</body>
</html>