<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Cuenta | Conecta 360¬∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root { --brand-primary: #FF9900; --brand-accent: #9ECA57; --brand-dark: #111111; --bg-light: #F4F4F4; --white: #FFFFFF; --sidebar-width: 280px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-light); color: var(--brand-dark); min-height: 100vh; display: block; overflow-x: hidden; overflow-y: auto; }

        /* LOADING */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HEADER & NOTIF */
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .notification-icon { font-size: 1.5rem; color: var(--brand-dark); cursor: pointer; position: relative; }
        #notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: red; border-radius: 50%; display: none; }
        #notif-drawer { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: white; z-index: 4500; box-shadow: -5px 0 20px rgba(0,0,0,0.1); padding: 20px; transition: 0.3s; }
        #notif-drawer.open { right: 0; }

        /* LOGIN */
        #login-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-dark) 100%); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .login-card { background: var(--white); padding: 40px 30px; border-radius: 25px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .form-input { width: 100%; padding: 16px; border: 2px solid #eee; border-radius: 12px; margin-bottom:15px; font-family: 'Montserrat', sans-serif; }
        .btn-primary { background: var(--brand-accent); color: var(--brand-dark); border: none; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%; }
        
        /* APP LAYOUT */
        #app-view { display: none; width: 100%; }
        .sidebar { width: var(--sidebar-width); background: var(--white); height: 100vh; border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 30px; position: fixed; top: 0; left: 0; z-index: 100; }
        .nav-link { display: flex; align-items: center; gap: 15px; padding: 14px 20px; text-decoration: none; color: #666; font-weight: 600; border-radius: 12px; transition: all 0.2s; font-size: 0.95rem; margin-bottom: 8px; }
        .nav-link:hover, .nav-link.active { background: #fff8eb; color: var(--brand-primary); }
        .main-content { margin-left: var(--sidebar-width); padding: 40px; width: calc(100% - var(--sidebar-width)); min-height: 100vh; }
        .section-view { display: none; animation: fadeIn 0.4s ease; }
        .section-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .card { background: var(--white); border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
        .card-label { color: #888; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; }
        .card-value { font-size: 2rem; font-weight: 900; color: var(--brand-dark); }
        
        .btn-whatsapp { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-radius: 12px; border: 1px solid #eee; background: #fff; color: #333; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: 0.2s; text-decoration: none; width: 100%; margin-bottom: 10px; }
        .btn-secondary { background: var(--brand-dark); color: white; border: none; padding: 12px; border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%; margin-top: auto; }

        .taller-card { border: 1px solid #eee; border-radius: 15px; padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; }
        .taller-badge { position: absolute; top: 15px; right: 15px; background: var(--brand-accent); color: var(--brand-dark); padding: 5px 10px; border-radius: 20px; font-weight: 800; font-size: 0.7rem; }
        .price-strike { text-decoration: line-through; color: #999; font-size: 0.9rem; margin-right: 5px; }
        .price-final { color: var(--brand-primary); font-weight: 900; font-size: 1.2rem; }
        
        .file-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; text-decoration: none; color: #333; transition: 0.2s; border:1px solid #eee; }
        .file-item:hover { background: #fff8e1; border-color: var(--brand-primary); }
        .file-icon { width: 40px; height: 40px; background: #ffe0b2; color: var(--brand-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        .pulsing-dot { width: 12px; height: 12px; background-color: #00ff88; border-radius: 50%; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); } }

        .plans-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .plan-card { background: white; border: 2px solid #eee; border-radius: 20px; padding: 30px; text-align: center; }
        .plan-card.active-plan { border: 2px solid var(--brand-accent); background: #f9fff6; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .list-title { font-weight: 700; font-size: 0.95rem; }
        .list-sub { font-size: 0.8rem; color: #888; }
        .tag-ok { background: #e8f5e9; color: green; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; display: none; justify-content: center; align-items: end; }
        .modal-content { background: white; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 25px 25px 0 0; padding: 25px; display: flex; flex-direction: column; }

        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; } 
            .main-content { margin-left: 0; width: 100%; padding: 20px; padding-bottom: 100px; }
            .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.98); border-top: 1px solid #eee; z-index: 1000; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .mobile-link { text-decoration: none; color: #999; text-align: center; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 5px; flex: 1; }
            .mobile-link.active { color: var(--brand-primary); font-weight: 700; }
        }
    </style>
</head>
<body>

    <div id="notif-drawer">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Notificaciones</h3><button onclick="toggleNotif()" style="border:none;background:none;">‚úï</button>
        </div>
        <p style="color:#888;">No tienes notificaciones nuevas.</p>
    </div>

    <div id="loading-screen"><div class="spinner"></div><p style="font-weight: 600; color: #666;">Cargando...</p></div>

    <div id="login-view">
        <div class="login-card">
            <img src="img/conecta.png" style="width: 150px; margin-bottom: 25px;">
            <p style="color: #666; margin-bottom: 30px; font-weight: 600;">Acceso Miembros</p>
            <form id="loginForm">
                <input type="email" class="form-input" placeholder="Email" required>
                <input type="password" id="loginPass" class="form-input" placeholder="Contrase√±a" required>
                <button type="submit" class="btn-primary">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-view">
        <aside class="sidebar">
            <div class="brand"><img src="img/conecta.png" style="height: 50px; width: auto;"></div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#" class="nav-link active" onclick="navTo('dashboard', this)"><i class="fas fa-home"></i> <span>Resumen</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('talleres', this)"><i class="fas fa-ticket-alt"></i> <span>Talleres</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('activity', this)"><i class="fas fa-folder-open"></i> <span>Mi Espacio</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('planes', this)"><i class="fas fa-star"></i> <span>Planes</span></a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="navTo('perfil', this)"><i class="fas fa-user-cog"></i> <span>Mis Datos</span></a></li>
            </ul>
            <div class="user-mini-profile" onclick="logout()" style="cursor:pointer; padding-top:20px; font-weight:bold;">Cerrar Sesi√≥n</div>
        </aside>

        <main class="main-content">
            <div class="top-header">
                <h2>Hola, <span class="highlight-text" id="user-name-display">...</span> üëã</h2>
                <div class="notification-icon" onclick="toggleNotif()"><i class="fas fa-bell"></i><div id="notif-badge"></div></div>
            </div>

            <div id="active-session-card" style="display: none; background: #111; border-left: 5px solid #00ff88; border-radius: 10px; padding: 15px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,255,136,0.15); align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="pulsing-dot"></div>
                    <div>
                        <p style="font-size: 0.75rem; color: #888; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px;">Estado Actual</p>
                        <h3 id="active-service-name" style="color: white; font-size: 1rem; margin: 0;">Usando Servicio...</h3>
                        <p id="session-timer" style="color: #00ff88; font-size: 0.8rem; margin-top: 2px;">Calculando...</p>
                    </div>
                </div>
                <button onclick="endSession()" style="background: #333; color: white; border: 1px solid #555; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">Finalizar</button>
            </div>

            <div id="dashboard" class="section-view active">
                <div class="dashboard-grid">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <div><span class="card-label">PLAN ACTUAL</span><div class="card-value highlight-text" id="current-plan-name" style="font-size:1.5rem;">...</div></div>
                            <span class="badge-active">ACTIVO</span>
                        </div>
                        <ul style="list-style:none; color:#666; font-size:0.9rem;" id="dashboard-features-list"></ul>
                    </div>
                    
                    <div class="card">
                        <span class="card-label" style="margin-bottom: 20px;">ACCIONES R√ÅPIDAS</span>
                        <button class="btn-whatsapp" onclick="openWhatsApp('Estudio de Grabaci√≥n')"><span>üéôÔ∏è Reservar Estudio</span> <i class="fab fa-whatsapp"></i></button>
                        <button class="btn-whatsapp" onclick="openWhatsApp('Sesi√≥n de Fotos')"><span>üì∏ Agendar Fotos</span> <i class="fab fa-whatsapp"></i></button>
                        <button class="btn-whatsapp" onclick="openRegistroObras()"><span>üéº Registrar Nueva Canci√≥n</span> <i class="fas fa-pen-nib"></i></button>
                        <button class="btn-whatsapp" onclick="openWhatsApp('Asesor√≠a')"><span>üéì Solicitar Asesor√≠a</span> <i class="fab fa-whatsapp"></i></button>
                        <button class="btn-whatsapp" onclick="openWhatsApp('Soporte')"><span>üÜò Soporte</span> <i class="fab fa-whatsapp"></i></button>
                    </div>
                </div>
            </div>

            <div id="talleres" class="section-view">
                <h2>Talleres y Eventos</h2>
                <p class="subtitle">Aprovecha los descuentos exclusivos de tu plan.</p>
                <div id="workshops-list"></div>
            </div>

            <div id="activity" class="section-view">
                <h2>Mi Espacio</h2>
                <p class="subtitle">Tus archivos, historial y progreso.</p>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 style="margin-bottom:15px;">üìÇ Mis Entregables</h3>
                        <div id="deliverables-list"><p style="color:#888;">No hay archivos compartidos.</p></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom:15px;">üéì Bit√°cora de Asesor√≠a</h3>
                        <div id="advisory-list"><p style="color:#888;">Sin notas.</p></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom:15px;">üìú Historial de Uso</h3>
                        <div id="history-list"><p style="color:#888;">Cargando...</p></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom:15px;">üé∏ Equipos Disponibles</h3>
                        <div id="inventory-list"><p style="color:#888;">Cargando...</p></div>
                    </div>
                </div>
            </div>

            <div id="planes" class="section-view">
                <h2 style="margin-bottom:20px;">Planes y Pagos</h2>
                <button class="btn-whatsapp" style="background:#f0fff4; border-color:#25D366; color:#155724; justify-content:center; gap:10px; margin-bottom:30px;" onclick="reportPayment()">
                    <i class="fas fa-file-invoice-dollar"></i> Reportar / Enviar Comprobante
                </button>
                <div class="plans-grid" id="plans-container-render"></div>
            </div>

            <div id="perfil" class="section-view">
                <h2>Mis Datos</h2>
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">Informaci√≥n</h3>
                        <div id="profile-alert" class="alert-box alert-success" style="display:none; color:green;">Guardado correctamente.</div>
                        <form onsubmit="updateProfile(event)">
                            <div class="form-group"><label>Nombre</label><input type="text" id="input-name" class="form-input" disabled style="background:#f5f5f5;"></div>
                            <div class="form-group"><label>Email</label><input type="email" id="input-email" class="form-input" disabled style="background:#f5f5f5;"></div>
                            <div class="form-group"><label>Tel√©fono</label><input type="tel" id="input-phone" class="form-input"></div>
                            <button type="submit" class="btn-secondary">Guardar Cambios</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">Seguridad</h3>
                        <div id="pass-success" class="alert-box alert-success" style="display:none; color:green;">¬°Contrase√±a actualizada!</div>
                        <form onsubmit="changePassword(event)">
                            <div class="form-group"><label>Contrase√±a Actual</label><input type="password" id="current-pass" class="form-input" required></div>
                            <div class="form-group"><label>Nueva Contrase√±a</label><input type="password" id="new-pass" class="form-input" required></div>
                            <button type="submit" id="btn-change-pass" class="btn-primary">Actualizar Contrase√±a</button>
                        </form>
                    </div>
                    <div class="card" style="background:transparent; border:none; box-shadow:none;">
                        <button onclick="logout()" class="btn-secondary" style="background-color:#ffe5e5; color:#d32f2f;">CERRAR SESI√ìN</button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="mobile-nav">
            <a href="#" class="mobile-link active" onclick="navTo('dashboard', this)"><i class="fas fa-home"></i><span>Inicio</span></a>
            <a href="#" class="mobile-link" onclick="navTo('talleres', this)"><i class="fas fa-ticket-alt"></i><span>Talleres</span></a>
            <a href="#" class="mobile-link" onclick="navTo('activity', this)"><i class="fas fa-folder"></i><span>Espacio</span></a>
            <a href="#" class="mobile-link" onclick="navTo('perfil', this)"><i class="fas fa-user-circle"></i><span>Perfil</span></a>
        </nav>
    </div>

    <div id="calendar-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>Disponibilidad</h3><button onclick="closeModal('calendar-modal')" style="border:none;background:none;font-size:1.5rem;">‚úï</button>
            </div>
            <div style="flex:1; background:#eee; margin-bottom:20px; height:400px;">
                <iframe id="google-calendar-frame" src="" style="width:100%; height:100%; border:0;"></iframe>
            </div>
            <button class="btn-primary" onclick="proceedToWhatsApp()">Solicitar Reserva</button>
        </div>
    </div>

    <div id="obras-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>üéº Registrar Obra</h3><button onclick="closeModal('obras-modal')" style="border:none;background:none;font-size:1.5rem;">‚úï</button>
            </div>
            <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Completa los datos para iniciar el tr√°mite de registro.</p>
            <form onsubmit="submitObra(event)">
                <div class="form-group"><label>T√≠tulo de la Canci√≥n</label><input type="text" id="obra-titulo" class="form-input" required></div>
                <div class="form-group"><label>Autores</label><input type="text" id="obra-autores" class="form-input" required></div>
                <div class="form-group"><label>Link a Letra/Demo</label><input type="url" id="obra-link" class="form-input" placeholder="https://..." required></div>
                <button type="submit" class="btn-primary">Enviar Solicitud</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBve-f9-BAlYHdgLx0NLjwMK8z5l8C8yW4",
            authDomain: "conecta360-c0259.firebaseapp.com",
            projectId: "conecta360-c0259",
            storageBucket: "conecta360-c0259.firebasestorage.app",
            messagingSenderId: "614768909024",
            appId: "1:614768909024:web:2bb1dc4cc5ecd3efe54e85"
        };

        let BUSINESS_PHONE = "595972310741"; 
        const DEFAULT_CALENDAR = "https://calendar.google.com/calendar/embed?src=5ae0bde3091f10d6624346171ee5ac12f39487c5aae0580cc5d51e3d11441153%40group.calendar.google.com&ctz=America%2FAsuncion";
        let dynamicCalendarUrl = DEFAULT_CALENDAR;
        let sessionInterval = null;

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const plansData = { basico: { discount: 0.10 }, desarrollo: { discount: 0.15 }, pro: { discount: 0.20 }, premium: { discount: 0.25 } };
        const fullPlansData = {
            basico: { name: 'üü° Plan B√°sico', price: '350.000', features: ['1 asesor√≠a', '1 sesi√≥n foto', '2hs Estudio', '10% off talleres'] },
            desarrollo: { name: 'üü† Plan Desarrollo', price: '550.000', features: ['1 asesor√≠a', 'Registro obras', '3hs Estudio', '15% off talleres'] },
            pro: { name: 'üî¥ Plan Pro', price: '950.000', features: ['Asesor√≠a trimestral', 'Registro obras', '4hs Estudio', 'Networking'] },
            premium: { name: '‚ö´ Plan Premium', price: '1.500.000', features: ['Asesor√≠a semanal', 'Registro obras', '2hs sem. estudio', 'Prioridad'] }
        };

        let currentUserDoc = null;
        let currentServiceType = '';

        auth.onAuthStateChanged((user) => {
            if (user) { 
                if(!currentUserDoc || currentUserDoc.uid !== user.uid) loadUserData(user.uid); 
            } else { 
                hideLoading(); 
                document.getElementById('login-view').style.display = 'flex'; 
                document.getElementById('app-view').style.display = 'none'; 
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            showLoading();
            auth.signInWithEmailAndPassword(e.target.querySelector('input[type="email"]').value, document.getElementById('loginPass').value)
            .catch((error) => { hideLoading(); alert("Error: " + error.message); });
        });

      function loadUserData(uid) {
            console.log("Buscando datos para el usuario:", uid); // Para depuraci√≥n

            db.collection("usuarios").doc(uid).onSnapshot((doc) => {
                if (doc.exists) {
                    // --- CASO DE √âXITO: EL USUARIO EXISTE ---
                    currentUserDoc = doc.data();
                    currentUserDoc.uid = uid;
                    
                    // Chequeo de Token pendiente (Android)
                    const pendingToken = localStorage.getItem('tempFCMToken');
                    if (pendingToken) {
                        console.log("Subiendo token pendiente...");
                        db.collection("usuarios").doc(uid).update({ fcmToken: pendingToken });
                        localStorage.removeItem('tempFCMToken');
                    }

                    // Cargar Configuraci√≥n General
                    db.collection("config").doc("general").get().then(d => { 
                        if(d.exists) { 
                            if(d.data().calendarUrl) dynamicCalendarUrl = d.data().calendarUrl; 
                            if(d.data().whatsapp) BUSINESS_PHONE = d.data().whatsapp; 
                        }
                    });

                    // Iniciar UI
                    initAppUI();
                    loadClientHistory(uid);
                    loadClientInventory();
                    loadWorkshops();
                    loadDeliverables(); 
                    loadAdvisory(); 
                    
                    if (currentUserDoc.session && currentUserDoc.session.active) {
                        showSessionCard(currentUserDoc.session.service, currentUserDoc.session.startTime, currentUserDoc.session.duration);
                    } else {
                        document.getElementById('active-session-card').style.display = 'none';
                        if(sessionInterval) clearInterval(sessionInterval);
                    }

                    // ¬°AQU√ç SE QUITA LA PANTALLA DE CARGA!
                    hideLoading();
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('app-view').style.display = window.innerWidth <= 768 ? 'block' : 'flex';

                } else {
                    // --- CASO DE ERROR: EL USUARIO NO TIENE DATOS ---
                    console.error("Usuario autenticado pero sin perfil en Firestore.");
                    hideLoading();
                    alert("Error: Tu cuenta no tiene un perfil de artista configurado. Contacta al administrador.");
                    auth.signOut(); // Cerramos sesi√≥n para que no se quede en el limbo
                }
            }, (error) => {
                // --- CASO DE ERROR DE CONEXI√ìN O PERMISOS ---
                console.error("Error al leer base de datos:", error);
                hideLoading();
                alert("Error de conexi√≥n: " + error.message);
            });
        }
        // --- CARGAR ENTREGABLES (LINK DESDE ADMIN) ---
        function loadDeliverables() {
            const list = document.getElementById('deliverables-list');
            if(currentUserDoc.deliverableLink && currentUserDoc.deliverableLink.trim() !== "") {
                list.innerHTML = `
                    <a href="${currentUserDoc.deliverableLink}" target="_blank" class="file-item">
                        <div class="file-icon"><i class="fas fa-folder-open"></i></div>
                        <div><div style="font-weight:700;">Ver mis Archivos</div><div style="font-size:0.8rem; color:#666;">Haz clic para abrir</div></div>
                    </a>`;
            } else {
                list.innerHTML = `<p style="color:#888; font-style:italic;">No hay archivos compartidos a√∫n.</p>`;
            }
        }

        // --- CARGAR BIT√ÅCORA (NOTAS VISIBLES DESDE ADMIN) ---
        function loadAdvisory() {
            const list = document.getElementById('advisory-list');
            if(currentUserDoc.advisoryNotes && currentUserDoc.advisoryNotes.trim() !== "") {
                list.innerHTML = `<div style="background:#f9f9f9; padding:15px; border-radius:10px;"><p style="font-size:0.95rem; line-height:1.5;">${currentUserDoc.advisoryNotes}</p></div>`;
            } else {
                list.innerHTML = `<p style="color:#888; font-style:italic;">Sin notas registradas.</p>`;
            }
        }

        // --- HISTORIAL (ORDENADO EN LOCAL) ---
        function loadClientHistory(uid) {
            db.collection("historial").where("uid", "==", uid).get()
            .then(snap => {
                const list = document.getElementById('history-list');
                if(snap.empty) { 
                    list.innerHTML = "<p style='color:#999; font-style:italic;'>Sin historial reciente.</p>"; 
                    return; 
                }
                
                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                
                // ORDENAR EN JS (M√°s seguro para evitar errores de √≠ndice en Firebase)
                docs.sort((a, b) => {
                    const dateA = a.fecha && a.fecha.toDate ? a.fecha.toDate() : new Date(a.fecha || 0);
                    const dateB = b.fecha && b.fecha.toDate ? b.fecha.toDate() : new Date(b.fecha || 0);
                    return dateB - dateA;
                });

                list.innerHTML = "";
                // Mostrar √∫ltimos 5
                docs.slice(0, 5).forEach(d => {
                    const dateObj = d.fecha && d.fecha.toDate ? d.fecha.toDate() : new Date(d.fecha);
                    const dateStr = dateObj.toLocaleDateString();
                    // Usamos d.duracion directamente porque ahora el admin guarda "2h 30m"
                    list.innerHTML += `
                        <div class="list-item">
                            <div><div class="list-title">${d.servicio}</div><div class="list-sub">${dateStr}</div></div>
                            <div class="tag-ok">${d.duracion || 'Fin'}</div>
                        </div>`;
                });
            })
            .catch(err => {
                console.error("Error historial:", err);
                document.getElementById('history-list').innerHTML = "<p style='color:red;'>Error al cargar historial.</p>";
            });
        }

        function loadClientInventory() {
            db.collection("inventario").where("estado", "==", "OK").get().then(snap => {
                const list = document.getElementById('inventory-list');
                if(snap.empty) { list.innerHTML = "<p style='color:#888;'>No hay equipos disponibles.</p>"; return; }
                list.innerHTML = "";
                snap.forEach(doc => { 
                    const i = doc.data(); 
                    list.innerHTML += `<div class="list-item"><div><div class="list-title">${i.item}</div></div><div class="tag-ok">${i.cantidad} Disp.</div></div>`; 
                });
            }).catch(err => {
                document.getElementById('inventory-list').innerHTML = "<p style='color:red;'>Error inventario.</p>";
            });
        }

        function loadWorkshops() {
            const workshops = [
                { id: 1, title: "Producci√≥n Musical B√°sica", date: "15 Nov", price: 100000, type: "taller" },
                { id: 2, title: "Marketing para Artistas", date: "20 Nov", price: 150000, type: "taller" },
                { id: 3, title: "Noche de Networking", date: "25 Nov", price: 50000, type: "networking" }
            ];
            const container = document.getElementById('workshops-list');
            container.innerHTML = "";
            const userPlanKey = currentUserDoc.plan_actual || 'basico';
            const discount = plansData[userPlanKey] ? plansData[userPlanKey].discount : 0;
            const isProOrPremium = (userPlanKey === 'pro' || userPlanKey === 'premium');

            workshops.forEach(w => {
                let finalPrice = w.price;
                let priceHtml = "";
                if (w.type === 'networking' && isProOrPremium) {
                    priceHtml = `<span class="price-strike">Gs. ${w.price}</span> <span class="price-final" style="color:green;">¬°GRATIS!</span>`;
                } else {
                    finalPrice = w.price - (w.price * discount);
                    priceHtml = `<span class="price-strike">Gs. ${w.price}</span> <span class="price-final">Gs. ${finalPrice}</span>`;
                }
                container.innerHTML += `<div class="taller-card"><span class="taller-badge">${w.date}</span><h3 style="margin-bottom:5px;">${w.title}</h3><div style="margin-bottom:10px;">${priceHtml}</div><button class="btn-secondary" style="padding:8px; font-size:0.8rem;" onclick="reserveWorkshop('${w.title}')">Inscribirme</button></div>`;
            });
        }

        function openRegistroObras() { document.getElementById('obras-modal').style.display='flex'; }
        function submitObra(e) {
            e.preventDefault();
            const titulo = document.getElementById('obra-titulo').value;
            const msg = `Hola, quiero registrar mi obra: "${titulo}". Ya sub√≠ los datos a la App.`;
            db.collection("tramites").add({ uid: currentUserDoc.uid, tipo: 'Registro Obra', titulo: titulo, autores: document.getElementById('obra-autores').value, link: document.getElementById('obra-link').value, fecha: new Date(), estado: 'Pendiente' })
            .then(() => { closeModal('obras-modal'); window.location.href = `https://wa.me/${BUSINESS_PHONE}?text=${encodeURIComponent(msg)}`; });
        }

        function initAppUI() {
            document.getElementById('user-name-display').innerText = currentUserDoc.nombre || "Artista";
            document.getElementById('input-name').value = currentUserDoc.nombre || "";
            document.getElementById('input-email').value = currentUserDoc.email || "";
            document.getElementById('input-phone').value = currentUserDoc.telefono || "";
            const plan = fullPlansData[currentUserDoc.plan_actual || 'basico'];
            document.getElementById('current-plan-name').innerText = plan.name;
            const list = document.getElementById('dashboard-features-list'); list.innerHTML = '';
            plan.features.forEach(f => list.innerHTML += `<li><i class="fas fa-check"></i> ${f}</li>`);
            const container = document.getElementById('plans-container-render'); container.innerHTML = '';
            Object.keys(fullPlansData).forEach(key => {
                const p = fullPlansData[key];
                const isActive = key === (currentUserDoc.plan_actual || 'basico');
                container.innerHTML += `<div class="plan-card ${isActive ? 'active-plan' : ''}"><span style="font-weight:800; font-size:1.2rem;">${p.name}</span><div style="font-size:1.5rem; font-weight:900; margin:10px 0; color:var(--brand-primary);">Gs. ${p.price}</div><ul style="text-align:left; font-size:0.9rem; list-style:none;">${p.features.map(f=>`<li>‚Ä¢ ${f}</li>`).join('')}</ul>${!isActive ? `<button class="btn-secondary" onclick="changePlan('${key}')">Elegir</button>` : ''}</div>`;
            });
        }

        function reserveWorkshop(title) { window.location.href = `https://wa.me/${BUSINESS_PHONE}?text=${encodeURIComponent("Hola, quiero inscribirme al taller: " + title)}`; }
        function reportPayment() { window.location.href = `https://wa.me/${BUSINESS_PHONE}?text=${encodeURIComponent(`Hola, soy ${currentUserDoc.nombre}. Env√≠o mi comprobante de pago.`)}`; }
        function toggleNotif() { document.getElementById('notif-drawer').classList.toggle('open'); document.getElementById('notif-badge').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }

        function showSessionCard(name, startTime, duration = 7200000) {
            const card = document.getElementById('active-session-card');
            document.getElementById('active-service-name').innerText = name;
            card.style.display = 'flex';
            if(sessionInterval) clearInterval(sessionInterval);
            const endTime = startTime + duration;
            sessionInterval = setInterval(() => {
                const diff = endTime - new Date().getTime();
                const timerTxt = document.getElementById('session-timer');
                if (diff <= 0) {
                    timerTxt.innerText = "TIEMPO FINALIZADO"; timerTxt.style.color = "#ff4444";
                    card.style.borderLeft = "5px solid #ff4444"; document.querySelector('.pulsing-dot').style.backgroundColor = "#ff4444";
                } else {
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    timerTxt.innerText = `Quedan: ${h}h ${m}m`;
                }
            }, 1000);
        }
        function endSession() { if(confirm("¬øFinalizar?")) db.collection("usuarios").doc(currentUserDoc.uid).update({ session: null }); }

        function openWhatsApp(type) {
            currentServiceType = type;
            if(type === 'Soporte') { proceedToWhatsApp(); return; }
            document.getElementById('google-calendar-frame').src = dynamicCalendarUrl + "&mode=AGENDA&showTitle=0&showNav=1&showDate=1&showPrint=0&showTabs=0&showCalendars=0";
            document.getElementById('calendar-modal').style.display = 'flex';
        }
        function proceedToWhatsApp() {
            const msg = `Hola, soy ${currentUserDoc.nombre}. Quiero reservar ${currentServiceType}.`;
            window.location.href = `https://wa.me/${BUSINESS_PHONE}?text=${encodeURIComponent(msg)}`;
            closeModal('calendar-modal');
        }
        
        function navTo(id, el) { 
            document.querySelectorAll('.section-view').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('.mobile-link').forEach(l=>l.classList.remove('active'));
            const idx = ['dashboard','talleres','activity','planes','perfil'].indexOf(id);
            if(idx !== -1 && document.querySelectorAll('.mobile-link')[idx]) document.querySelectorAll('.mobile-link')[idx].classList.add('active');
        }
        
        function showLoading() { document.getElementById('loading-screen').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-screen').style.display = 'none'; }
        function logout() { if(confirm("¬øCerrar sesi√≥n?")) { showLoading(); auth.signOut().then(() => location.reload()); } }
        function toggleLoginPassword(i) { const p = document.getElementById('loginPass'); p.type = p.type==='password'?'text':'password'; i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash'); }
        function updateProfile(e) { e.preventDefault(); db.collection("usuarios").doc(auth.currentUser.uid).update({ telefono: document.getElementById('input-phone').value }).then(()=>{ document.getElementById('profile-alert').style.display='block'; setTimeout(()=>document.getElementById('profile-alert').style.display='none',3000); }); }
        function changePassword(e) { e.preventDefault(); const p=document.getElementById('new-pass').value; auth.currentUser.updatePassword(p).then(()=>alert("Contrase√±a actualizada")).catch(e=>alert(e.message)); }
        function changePlan(key) { if(confirm("¬øCambiar plan?")) window.location.href = `https://wa.me/${BUSINESS_PHONE}?text=Hola, soy ${currentUserDoc.nombre}, quiero cambiar al plan ${key}`; }

        // --- FUNCI√ìN PARA RECIBIR TOKEN DESDE ANDROID STUDIO ---
        function saveFCMToken(token) {
            console.log("üì≤ Token recibido desde Android:", token);
            
            // Si el usuario ya est√° logueado, guardamos directo en Firebase
            if (auth.currentUser) {
                db.collection("usuarios").doc(auth.currentUser.uid).update({
                    fcmToken: token
                }).then(() => {
                    console.log("‚úÖ Token guardado en Firebase exitosamente.");
                }).catch(err => {
                    console.error("‚ùå Error al guardar token:", err);
                });
            } else {
                // Si a√∫n no se ha logueado, lo guardamos en la memoria del celular temporalmente
                localStorage.setItem('tempFCMToken', token);
                console.log("‚è≥ Usuario no logueado. Token guardado en memoria temporal.");
            }
        }
    </script>
</body>
</html>